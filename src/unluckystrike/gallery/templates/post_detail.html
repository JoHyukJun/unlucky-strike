{% extends "base.html" %}

{% block title %}{{ post.caption|default:"Post" }} - Unlucky Strike{% endblock %}

{% block content %}
<section class="post-detail-wrap">
  <header class="detail-header">
    <a href="{% url 'gallery:gallery_index' %}" class="back-link">&larr; BACK</a>
    <h1>{{ post.caption|default:"Untitled" }}</h1>
    <div class="meta">
      <span class="author">by {{ post.uploaded_by.username|default:"Anonymous" }}</span>
      <time>{{ post.created_at|date:"Y-m-d" }}</time>
      <span class="likes-count">LIKE {{ post.likes.count }}</span>
    </div>
  </header>

  <div class="media-block">
    <div class="main-photo-box">
      {% with first=post.photos.first %}
        {% if first %}
          <img id="active-photo" src="{{ first.image.url }}" alt="main" class="main-photo">
        {% else %}
          <div class="no-photo">NO IMAGE</div>
        {% endif %}
      {% endwith %}
    </div>
    {% if post.photos.count > 1 %}
    <div class="thumb-strip">
      {% for ph in post.photos.all %}
        <button class="thumb-btn" data-src="{{ ph.image.url }}">
          <img src="{{ ph.image.url }}" alt="thumb {{ forloop.counter }}">
        </button>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <div class="post-info">
    {% if post.tags.exists %}
    <div class="tags">
      {% for tag in post.tags.all %}
        <a href="{% url 'gallery:tagged_photos' tag.name %}" class="tag">#{{ tag.name }}</a>
      {% endfor %}
    </div>
    {% endif %}

    <div class="actions">
      {% if user.is_authenticated %}
        <button id="like-btn" class="btn" data-url="{% url 'gallery:post_like' post.pk %}">
          {% if user in post.likes.all %}Undo Like{% else %}Like{% endif %}
        </button>
      {% endif %}
      {% with first=post.photos.first %}
        {% if first %}
          <a href="{{ first.image.url }}" download class="btn">DOWNLOAD</a>
        {% endif %}
      {% endwith %}
    </div>
  </div>

  <div class="comments-section">
    <h3>Comments ({{ comments.count }})</h3>
    {% if user.is_authenticated %}
    <form method="post" action="#" class="comment-form">
      {% csrf_token %}
      <textarea name="text" placeholder="Leave a comment..." rows="3" required></textarea>
      <button type="submit" class="btn">Submit</button>
    </form>
    {% else %}
    {% endif %}
    <div class="comments-list">
      {% for comment in comments %}
      <article class="comment">
        <div class="comment-header">
          <strong class="author">{{ comment.user.username|default:"Anonymous" }}</strong>
          <time>{{ comment.created_at|date:"Y-m-d H:i" }}</time>
        </div>
        <p class="comment-text">{{ comment.text }}</p>
      </article>
      {% empty %}
      <p class="empty">No comments.</p>
      {% endfor %}
    </div>
  </div>
</section>

<style>
.post-detail-wrap { max-width:960px; margin:32px auto; padding:0 18px; font-family:Georgia, serif; color:#222; }
.detail-header { margin-bottom:18px; }
.back-link { display:inline-block; margin-bottom:12px; color:#555; text-decoration:none; font-size:14px; }
.back-link:hover { color:#222; }
.detail-header h1 { margin:0 0 8px; font-size:28px; }
.meta { display:flex; gap:14px; flex-wrap:wrap; font-size:14px; color:#666; }
.media-block { margin-bottom:20px; }
.main-photo-box { background:#000; border-radius:8px; overflow:hidden; position:relative; }
.main-photo { width:100%; height:auto; display:block; object-fit:contain; max-height:70vh; }
.no-photo { height:300px; display:flex; align-items:center; justify-content:center; background:#eee; color:#777; font-size:14px; }
.thumb-strip { display:flex; gap:6px; margin-top:10px; overflow-x:auto; padding-bottom:6px; }
.thumb-btn { border:0; padding:0; background:none; cursor:pointer; flex:0 0 auto; }
.thumb-btn img { width:80px; height:100px; object-fit:cover; border-radius:4px; opacity:.85; transition:.25s; }
.thumb-btn:hover img, .thumb-btn.active img { opacity:1; transform:scale(1.04); }
.tags { margin-bottom:14px; display:flex; gap:8px; flex-wrap:wrap; }
.tag { background:#f3f3f3; color:#222; padding:6px 12px; border-radius:14px; font-size:13px; text-decoration:none; font-weight:600; }
.tag:hover { background:#e0e0e0; }
.actions { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:24px; }
.btn { border:0; cursor:pointer; text-decoration:none; }
.comments-section { border-top:1px solid #ddd; padding-top:22px; }
.comments-section h3 { margin:0 0 14px; font-size:20px; }
.comment-form { margin-bottom:22px; }
.comment-form textarea { width:100%; padding:10px 12px; border:1px solid #ccc; border-radius:6px; font-size:14px; font-family:inherit; background:#fffdf9; margin-bottom:10px; }
.comments-list { display:flex; flex-direction:column; gap:14px; }
.comment { background:#faf6f0; padding:12px 14px; border-radius:8px; border-left:3px solid #ccc; }
.comment-header { display:flex; justify-content:space-between; margin-bottom:6px; }
.comment-text { margin:0; font-size:14px; line-height:1.6; }
.empty { color:#999; font-size:14px; text-align:center; padding:18px 0; }
@media (max-width:600px){ .detail-header h1{font-size:22px;} .main-photo{max-height:60vh;} .thumb-btn img{width:64px;height:80px;} }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function getCookie(name){
    let v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  const likeBtn = document.getElementById('like-btn');
  if (likeBtn){
    likeBtn.addEventListener('click', function(){
      fetch(this.dataset.url, {
        method:'POST',
        headers:{'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'}
      }).then(r=>r.json()).then(data=>{
        this.textContent = data.status === 'liked' ? 'Undo Like' : 'Like';
        const lc = document.querySelector('.likes-count');
        if(lc) lc.textContent = 'LIKE ' + data.likes_count;
      }).catch(console.error);
    });
  }

  const active = document.getElementById('active-photo');
  document.querySelectorAll('.thumb-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.thumb-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const src = btn.dataset.src;
      if(active) active.src = src;
    });
  });
});
</script>
{% endblock %}