{% extends "base.html" %}

{% block title %}ETF - {{ etf.ticker }}  - Unlucky Strike{% endblock %}

{% block content %}
<h2>{{ etf.name }} 배당금 차트</h2>
<p style="color:#555; margin-bottom:24px;">
  {{ etf.description|default:"해당 ETF에 대한 설명이 없습니다." }}
</p>
<div style="margin-bottom:16px;">
  <label for="chartType">차트 타입 선택:</label>
  <select id="chartType">
    <option value="bar">막대차트</option>
    <option value="line">선차트</option>
  </select>
  <label for="dateType" style="margin-left:20px;">기준:</label>
  <select id="dateType">
    <option value="day">일별</option>
    <option value="month">월별</option>
    <option value="year">연별</option>
  </select>
  <label for="periodType" style="margin-left:20px;">기간:</label>
  <select id="periodType">
    <option value="1y">최근 1년</option>
    <option value="6m">최근 6개월</option>
    <option value="all">전체</option>
  </select>
</div>
<div style="width:100%;max-width:700px;margin:0 auto;">
  <canvas id="etf-chart"></canvas>
</div>
<style>
  #etf-chart {
    width: 100% !important;
    height: 50vh !important;
    min-height: 320px;
    max-height: 600px;
    background: #fff;
    border: 1px solid #aaa;
    border-radius: 8px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.08);
  }
  @media (max-width: 600px) {
    #etf-chart {
      height: 60vh !important;
      min-height: 260px;
      max-height: 80vh;
    }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // 원본 데이터
  const rawLabels = {{ labels|safe }};
  const rawData = {{ amounts|safe }}.map(x => Number.parseFloat(x).toFixed(6));
  const currency = "{{ currency|default:'원' }}";

  function groupData(labels, data, type) {
    const grouped = {};
    labels.forEach((label, idx) => {
      let key;
      if (type === 'day') {
        key = label;
      } else if (type === 'month') {
        key = label.slice(0, 7); // YYYY-MM
      } else if (type === 'year') {
        key = label.slice(0, 4); // YYYY
      }
      if (!grouped[key]) grouped[key] = 0;
      grouped[key] = (parseFloat(grouped[key]) + parseFloat(data[idx])).toFixed(6);
    });
    return {
      labels: Object.keys(grouped),
      data: Object.values(grouped)
    };
  }

  function filterPeriod(labels, data, periodType) {
    if (periodType === 'all') {
      return {labels, data};
    }
    const now = new Date();
    let cutoff;
    if (periodType === '6m') {
      cutoff = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
    } else if (periodType === '1y') {
      cutoff = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
    }
    const filteredLabels = [];
    const filteredData = [];
    labels.forEach((label, idx) => {
      const date = new Date(label);
      if (date >= cutoff) {
        filteredLabels.push(label);
        filteredData.push(data[idx]);
      }
    });
    return {labels: filteredLabels, data: filteredData};
  }

  let chartType = document.getElementById('chartType').value;
  let dateType = document.getElementById('dateType').value;
  let periodType = document.getElementById('periodType').value;

  function getChartData() {
    let grouped = groupData(rawLabels, rawData, dateType);
    let filtered = filterPeriod(grouped.labels, grouped.data, periodType);
    return filtered;
  }

  let chartData = getChartData();

  // Chart.js responsive 설정
  const ctx = document.getElementById('etf-chart').getContext('2d');
  let chart = new Chart(ctx, {
    type: chartType,
    data: {
      labels: chartData.labels,
      datasets: [{
        label: '배당금',
        data: chartData.data,
        backgroundColor: chartType === 'bar' ? 'rgba(60, 120, 216, 0.7)' : 'rgba(60, 120, 216, 0.2)',
        borderColor: 'rgba(60, 120, 216, 1)',
        borderWidth: 2,
        borderRadius: chartType === 'bar' ? 6 : 0,
        fill: chartType === 'line' ? false : true,
        tension: chartType === 'line' ? 0.4 : 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          labels: {
            color: '#333',
            font: { size: 14, family: 'Georgia, serif' }
          }
        },
        title: {
          display: true,
          text: '{{ etf.ticker }} 배당금 추이',
          font: { size: 20, family: 'Georgia, serif', weight: 'bold' },
          color: '#222',
          padding: {top: 16, bottom: 16}
        },
        tooltip: {
          backgroundColor: '#f8f8f8',
          titleColor: '#222',
          bodyColor: '#222',
          borderColor: '#aaa',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              return `배당금: ${Number.parseFloat(context.parsed.y).toFixed(6)} ${currency}`;
            }
          }
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: dateType === 'day' ? '지급일' : (dateType === 'month' ? '월' : '연도'),
            font: { size: 15, family: 'Georgia, serif' },
            color: '#333'
          },
          ticks: { color: '#555', font: { family: 'Georgia, serif' } },
          grid: { color: '#eee' }
        },
        y: {
          title: {
            display: true,
            text: `배당금(${currency})`,
            font: { size: 15, family: 'Georgia, serif' },
            color: '#333'
          },
          ticks: { color: '#555', font: { family: 'Georgia, serif' } },
          grid: { color: '#eee' },
          beginAtZero: true
        }
      }
    }
  });

  function updateChart() {
    chartType = document.getElementById('chartType').value;
    dateType = document.getElementById('dateType').value;
    periodType = document.getElementById('periodType').value;
    chartData = getChartData();
    chart.destroy();
    chart = new Chart(ctx, {
      type: chartType,
      data: {
        labels: chartData.labels,
        datasets: [{
          label: '배당금',
          data: chartData.data,
          backgroundColor: chartType === 'bar' ? 'rgba(60, 120, 216, 0.7)' : 'rgba(60, 120, 216, 0.2)',
          borderColor: 'rgba(60, 120, 216, 1)',
          borderWidth: 2,
          borderRadius: chartType === 'bar' ? 6 : 0,
          fill: chartType === 'line' ? false : true,
          tension: chartType === 'line' ? 0.4 : 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            labels: {
              color: '#333',
              font: { size: 14, family: 'Georgia, serif' }
            }
          },
          title: {
            display: true,
            text: '{{ etf.ticker }} 배당금 추이',
            font: { size: 20, family: 'Georgia, serif', weight: 'bold' },
            color: '#222',
            padding: {top: 16, bottom: 16}
          },
          tooltip: {
            backgroundColor: '#f8f8f8',
            titleColor: '#222',
            bodyColor: '#222',
            borderColor: '#aaa',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return `배당금: ${Number.parseFloat(context.parsed.y).toFixed(6)} ${currency}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: dateType === 'day' ? '지급일' : (dateType === 'month' ? '월' : '연도'),
              font: { size: 15, family: 'Georgia, serif' },
              color: '#333'
            },
            ticks: { color: '#555', font: { family: 'Georgia, serif' } },
            grid: { color: '#eee' }
          },
          y: {
            title: {
              display: true,
              text: `배당금(${currency})`,
              font: { size: 15, family: 'Georgia, serif' },
              color: '#333'
            },
            ticks: { color: '#555', font: { family: 'Georgia, serif' } },
            grid: { color: '#eee' },
            beginAtZero: true
          }
        }
      }
    });
  }

  document.getElementById('chartType').addEventListener('change', updateChart);
  document.getElementById('dateType').addEventListener('change', updateChart);
  document.getElementById('periodType').addEventListener('change', updateChart);
</script>
{% endblock %}